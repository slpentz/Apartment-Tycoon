<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Apartment Tycoon ‚Äî Multiplayer</title>
  <style>
    :root{
      --bg:#0f1220; --panel:#171b2e; --text:#e9ecff; --muted:#a9b0d9; --line:rgba(255,255,255,.12);
      --good:#45d483; --bad:#ff5b6b; --warn:#ffd166; --r:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, #1a2150 0%, var(--bg) 50%) fixed;
      color:var(--text);
    }
    header{
      padding:12px 14px; border-bottom:1px solid var(--line);
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
    }
    h1{font-size:16px;margin:0}
    .sub{font-size:12px;color:var(--muted);margin-top:3px}
    .wrap{max-width:1100px;margin:0 auto;padding:12px;padding-bottom:calc(12px + env(safe-area-inset-bottom));}
    .grid{display:grid;grid-template-columns:360px 1fr; gap:12px;}
    @media (max-width:900px){ .grid{grid-template-columns:1fr;} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line); border-radius:var(--r); overflow:hidden;
    }
    .hd{padding:12px;border-bottom:1px solid var(--line); background:rgba(0,0,0,.16); display:flex;justify-content:space-between;align-items:center;gap:10px;}
    .title{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.2px}
    .bd{padding:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;gap:7px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04);font-size:12px;color:var(--muted);white-space:nowrap;}
    .dot{width:10px;height:10px;border-radius:999px;border:1px solid rgba(255,255,255,.35);background:transparent;}
    button{
      background:#2b3570;color:var(--text);border:1px solid rgba(255,255,255,.18);
      border-radius:12px;padding:11px 14px;font-weight:750;cursor:pointer;touch-action:manipulation;
    }
    button.secondary{background:rgba(255,255,255,.06)}
    button.good{background:#1d5a3a}
    button.danger{background:#5b1b28}
    button:disabled{opacity:.5;cursor:not-allowed}
    input, select{
      background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.18);color:var(--text);
      border-radius:12px;padding:10px 12px;outline:none; width:100%;
    }
    label{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:12px 0;}

    /* Board area */
    .boardWrap{
      position:relative;
      width:100%;
      background:rgba(0,0,0,.18);
      border-top:1px solid var(--line);
      aspect-ratio: 2048 / 1462; /* your image ratio (approx) */
      overflow:hidden;
      border-radius:0 0 var(--r) var(--r);
    }
    .boardImg{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:contain;
      user-select:none; -webkit-user-drag:none;
    }

    /* Token layer uses same absolute coordinate system as image */
    .tokenLayer{position:absolute; inset:0; pointer-events:none;}
    .token{
      position:absolute;
      width:34px;height:34px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,.35);
      box-shadow: 0 10px 25px rgba(0,0,0,.28);
      transform: translate(-50%, -50%);
      font-weight:900;
      font-size:12px;
    }
    .token small{opacity:.9;font-weight:900}

    /* Clickable hotspots */
    .hotspotLayer{position:absolute; inset:0;}
    .hotspot{
      position:absolute;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.00);
      transition: background .12s ease, border-color .12s ease;
    }
    .hotspot:hover{background:rgba(123,155,255,.10);border-color:rgba(123,155,255,.25);}
    .hotspot:active{background:rgba(123,155,255,.18);}
    .hotspot[data-special="true"]{border-color:rgba(255,209,102,.25);}
    .hotspotLabel{
      position:absolute; left:8px; top:6px;
      font-size:11px; color:rgba(233,236,255,.85);
      text-shadow: 0 2px 10px rgba(0,0,0,.6);
      pointer-events:none;
    }

    .list{max-height:240px; overflow:auto; border:1px solid var(--line); border-radius:12px; background:rgba(0,0,0,.16); padding:8px;}
    .listItem{border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.04); border-radius:12px; padding:10px; margin-bottom:10px;}
    .listItem:last-child{margin-bottom:0}
    .big{font-weight:900;font-size:14px;margin-bottom:3px}
    .mini{font-size:12px;color:var(--muted);line-height:1.35}
    .log{height:240px;overflow:auto;border:1px solid var(--line);border-radius:12px;background:rgba(0,0,0,.18);padding:10px;font-size:12px;line-height:1.35}
    .line{margin-bottom:9px}
    .goodTxt{color:var(--good)} .badTxt{color:var(--bad)} .warnTxt{color:var(--warn)}
  </style>
</head>
<body>
    <header>
        <div>
            <h1>Apartment Tycoon ‚Äî Multiplayer</h1>
            <div class="sub">Uses your board image + live synced avatars (room code). Deploy on Netlify / GitHub Pages.</div>
        </div>
        <div class="row">
            <span class="pill"><span class="dot" id="turnDot"></span><span id="turnLabel">Not connected</span></span>
            <span class="pill">Dice: <b id="diceOut">‚Äì</b></span>
        </div>
    </header>

    <div class="wrap">
        <div class="grid">

            <!-- LEFT: Lobby / Controls -->
            <section class="card">
                <div class="hd"><div class="title">Room + Avatar</div></div>
                <div class="bd">
                    <div class="row" style="align-items:flex-end">
                        <div style="flex:1">
                            <label>Display name</label>
                            <input id="name" placeholder="Hydra, Player 1, etc" maxlength="16" />
                        </div>
                        <div style="width:110px">
                            <label>Icon</label>
                            <select id="icon">
                                <option>üò∫</option>
                                <option>ü¶ä</option>
                                <option>üê∫</option>
                                <option>üêº</option>
                                <option>üê∏</option>
                                <option>ü¶Å</option>
                                <option>üêµ</option>
                                <option>üßô</option>
                                <option>üßë‚Äçüîß</option>
                                <option>üßë‚ÄçüöÄ</option>
                            </select>
                        </div>
                    </div>

                    <div class="row" style="margin-top:10px">
                        <div style="flex:1">
                            <label>Color</label>
                            <input id="color" type="color" value="#7aa0ff" />
                        </div>
                        <div style="width:140px">
                            <label>Start cash</label>
                            <input id="startCash" type="number" value="4500" min="1000" step="100" />
                        </div>
                    </div>

                    <div class="hr"></div>

                    <div class="row">
                        <button class="good" id="btnCreate">Create Room</button>
                        <button class="secondary" id="btnJoin">Join Room</button>
                    </div>

                    <div class="row" style="margin-top:10px">
                        <div style="flex:1">
                            <label>Room code</label>
                            <input id="roomCode" placeholder="e.g. K9F2Q" maxlength="10" />
                        </div>
                        <button class="secondary" id="btnCopy">Copy</button>
                    </div>

                    <div class="hr"></div>

                    <div class="row">
                        <button id="btnRoll" class="good" disabled>Roll (current player)</button>
                        <button id="btnEnd" class="secondary" disabled>End Turn</button>
                        <button id="btnReset" class="danger" disabled>Reset Game</button>
                    </div>

                    <div class="hr"></div>

                    <div class="title" style="margin-bottom:8px;">Players</div>
                    <div class="list" id="playersList"></div>

                    <div class="hr"></div>

                    <div class="title" style="margin-bottom:8px;">Log</div>
                    <div class="log" id="log"></div>
                </div>
            </section>

            <!-- RIGHT: Board -->
            <section class="card">
                <div class="hd"><div class="title">Board (your design)</div></div>
                <div class="boardWrap" id="boardWrap">
                    <img class="boardImg" src="./board1.jpg" alt="Apartment Tycoon board" />
                    <div class="hotspotLayer" id="hotspots"></div>
                    <div class="tokenLayer" id="tokens"></div>
                </div>
                <div class="bd">
                    <div class="mini">
                        Tap a space to show its label (we‚Äôll map every apartment + card space next). Tokens move live.
                    </div>
                </div>
            </section>

        </div>
    </div>

    <script type="module">
        // ---------- Firebase (add your config in STEP 3 below) ----------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import {
            getDatabase, ref, set, get, update, onValue, push, serverTimestamp, runTransaction
        } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
        import {
            getAuth, signInAnonymously, onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

        const firebaseConfig = window.__FIREBASE_CONFIG__; // set in Step 3
        if (!firebaseConfig) {
            alert("Missing Firebase config. Follow Step 3 and paste your config.");
            throw new Error("Missing Firebase config");
        }

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // ---------- Utilities ----------
        const $ = (id) => document.getElementById(id);
        const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
        const randInt = (a, b) => Math.floor(Math.random() * (b - a + 1)) + a;

        function log(msg, cls = "") {
            const el = $("log");
            const div = document.createElement("div");
            div.className = "line " + cls;
            div.textContent = msg;
            el.appendChild(div);
            el.scrollTop = el.scrollHeight;
        }

        function makeRoomCode() {
            const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789";
            let s = "";
            for (let i = 0; i < 5; i++) s += chars[Math.floor(Math.random() * chars.length)];
            return s;
        }

        // ---------- Board mapping ----------
        // IMPORTANT:
        // These "spaces" are rectangles placed in % coords over the image (left, top, width, height).
        // We‚Äôll fill all 60+ later, but this is enough to prove multiplayer + tokens.
        //
        // You can add more by copying an entry and adjusting percentages.
        //
        const spaces = [
            { id: 0, name: "Lobby (Start)", x: 12, y: 88, w: 18, h: 9, special: true },
            { id: 1, name: "A-1", x: 32, y: 88, w: 6, h: 9 },
            { id: 2, name: "A-2", x: 39, y: 88, w: 6, h: 9 },
            { id: 3, name: "Apartment Card", x: 46, y: 88, w: 6, h: 9, special: true },
            { id: 4, name: "Swimming Pool", x: 53, y: 88, w: 9, h: 9, special: true },
            { id: 5, name: "A-3", x: 63, y: 88, w: 6, h: 9 },
            { id: 6, name: "A-4", x: 70, y: 88, w: 6, h: 9 },
            { id: 7, name: "A-5", x: 77, y: 88, w: 6, h: 9 },
            { id: 8, name: "Laundry (pay)", x: 84, y: 88, w: 8, h: 9, special: true },
            { id: 9, name: "Stairs / Move Up", x: 92, y: 86, w: 7, h: 12, special: true },

            // Top-left elevator door-ish (end)
            { id: 59, name: "Elevator Door (Top)", x: 15, y: 7, w: 10, h: 10, special: true },

            // Speakeasy in penthouse region (placeholder)
            { id: 56, name: "Humstring‚Äôs Speakeasy", x: 58, y: 12, w: 14, h: 10, special: true },
        ];

        // Map a track position (0..59) to a space rectangle center.
        // For now: if we don‚Äôt have a rectangle for a given id, we fall back to Lobby center.
        function spaceCenter(id) {
            const s = spaces.find(x => x.id === id) || spaces[0];
            return { cx: s.x + s.w / 2, cy: s.y + s.h / 2 };
        }

        function renderHotspots() {
            const layer = $("hotspots");
            layer.innerHTML = "";
            for (const s of spaces) {
                const d = document.createElement("div");
                d.className = "hotspot";
                d.style.left = s.x + "%";
                d.style.top = s.y + "%";
                d.style.width = s.w + "%";
                d.style.height = s.h + "%";
                d.dataset.special = s.special ? "true" : "false";

                const label = document.createElement("div");
                label.className = "hotspotLabel";
                label.textContent = s.name;

                d.appendChild(label);
                d.addEventListener("click", (e) => {
                    e.preventDefault();
                    log(`‚ÑπÔ∏è Space ${s.id}: ${s.name}`, "warnTxt");
                });

                layer.appendChild(d);
            }
        }

        function renderTokens(state) {
            const layer = $("tokens");
            layer.innerHTML = "";
            const players = state?.players ? Object.values(state.players) : [];
            for (const p of players) {
                const { cx, cy } = spaceCenter(p.pos ?? 0);

                const t = document.createElement("div");
                t.className = "token";
                t.style.left = cx + "%";
                t.style.top = cy + "%";
                t.style.background = p.color || "#7aa0ff";

                // icon + initials
                const initials = (p.name || "P").slice(0, 2).toUpperCase();
                t.innerHTML = `<div style="display:flex;flex-direction:column;align-items:center;line-height:1;">
                <div style="font-size:14px">${p.icon || "üôÇ"}</div>
                <small>${initials}</small>
              </div>`;
                layer.appendChild(t);
            }
        }

        function renderPlayers(state) {
            const el = $("playersList");
            el.innerHTML = "";
            const players = state?.players ? Object.values(state.players) : [];
            if (players.length === 0) {
                el.innerHTML = `<div class="mini" style="padding:6px 4px;">No players yet.</div>`;
                return;
            }
            players.sort((a, b) => (a.joinedAt || 0) - (b.joinedAt || 0));
            for (const p of players) {
                const div = document.createElement("div");
                div.className = "listItem";
                const turnBadge = (state?.turnUid === p.uid) ? ` <span class="pill" style="border-color:rgba(123,155,255,.35);color:var(--text)">TURN</span>` : "";
                div.innerHTML = `
                <div class="big">${p.icon || "üôÇ"} ${p.name || "Player"}${turnBadge}</div>
                <div class="mini">Cash: <b>$${p.cash ?? 0}</b> ‚Ä¢ Pos: <b>${p.pos ?? 0}</b></div>
              `;
                el.appendChild(div);
            }
        }

        function setTurnPill(state) {
            if (!state) { $("turnLabel").textContent = "Not connected"; $("turnDot").style.background = "transparent"; return; }
            const turnUid = state.turnUid;
            const turnPlayer = state.players?.[turnUid];
            $("turnLabel").textContent = turnPlayer ? `${turnPlayer.name}'s turn` : "Turn: ‚Äî";
            $("turnDot").style.background = turnPlayer?.color || "transparent";
            $("diceOut").textContent = state.lastRoll ?? "‚Äì";
        }

        // ---------- Multiplayer State ----------
        let myUid = null;
        let room = null; // room code
        let roomRef = null;

        function myProfile() {
            const name = ($("name").value || "Player").trim().slice(0, 16);
            const icon = $("icon").value;
            const color = $("color").value;
            const cash = Math.max(1000, parseInt($("startCash").value, 10) || 4500);
            return { name, icon, color, cash };
        }

        async function ensureSignedIn() {
            await signInAnonymously(auth);
            return new Promise((resolve) => {
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        myUid = user.uid;
                        resolve(user.uid);
                    }
                });
            });
        }

        async function createRoom() {
            await ensureSignedIn();
            const code = makeRoomCode();
            room = code;
            $("roomCode").value = code;
            roomRef = ref(db, `rooms/${code}`);

            const prof = myProfile();

            // Create room state
            const init = {
                createdAt: Date.now(),
                ownerUid: myUid,
                turnUid: myUid,
                lastRoll: null,
                started: true,
                players: {
                    [myUid]: {
                        uid: myUid,
                        name: prof.name,
                        icon: prof.icon,
                        color: prof.color,
                        cash: prof.cash,
                        pos: 0,
                        joinedAt: Date.now()
                    }
                }
            };

            await set(roomRef, init);
            log(`‚úÖ Room created: ${code}. Share this code.`, "goodTxt");
            attachRoomListener();
            enableGameButtons(true);
        }

        async function joinRoom() {
            await ensureSignedIn();
            const code = ($("roomCode").value || "").trim().toUpperCase();
            if (!code) { log("Enter a room code first.", "badTxt"); return; }

            room = code;
            roomRef = ref(db, `rooms/${code}`);

            const snap = await get(roomRef);
            if (!snap.exists()) { log("Room not found.", "badTxt"); return; }

            const prof = myProfile();

            // Add player
            await update(ref(db, `rooms/${code}/players/${myUid}`), {
                uid: myUid,
                name: prof.name,
                icon: prof.icon,
                color: prof.color,
                cash: prof.cash,
                pos: 0,
                joinedAt: Date.now()
            });

            log(`‚úÖ Joined room: ${code}.`, "goodTxt");
            attachRoomListener();
            enableGameButtons(true);
        }

        function attachRoomListener() {
            onValue(roomRef, (snap) => {
                const state = snap.val();
                window.__STATE__ = state; // for debugging
                setTurnPill(state);
                renderPlayers(state);
                renderTokens(state);

                // Only turn player can roll/end
                const isMyTurn = state?.turnUid === myUid;
                $("btnRoll").disabled = !isMyTurn;
                $("btnEnd").disabled = !isMyTurn;
                $("btnReset").disabled = !(state?.ownerUid === myUid);
            });
        }

        function enableGameButtons(enabled) {
            // roll/end are controlled by turn; this just unlocks UI after connect
            $("btnRoll").disabled = !enabled;
            $("btnEnd").disabled = !enabled;
            $("btnReset").disabled = !enabled;
        }

        async function roll() {
            if (!room) return;
            const d1 = randInt(1, 6), d2 = randInt(1, 6);
            const sum = d1 + d2;

            await runTransaction(roomRef, (state) => {
                if (!state) return state;
                if (state.turnUid !== myUid) return state;

                const me = state.players?.[myUid];
                if (!me) return state;

                const nextPos = ((me.pos || 0) + sum) % 60;
                me.pos = nextPos;

                state.lastRoll = `${d1}+${d2}=${sum}`;
                state.players[myUid] = me;
                return state;
            });

            log(`üé≤ You rolled ${d1} + ${d2} = ${sum}`, "warnTxt");
        }

        async function endTurn() {
            if (!room) return;

            await runTransaction(roomRef, (state) => {
                if (!state) return state;
                if (state.turnUid !== myUid) return state;

                const ids = Object.keys(state.players || {});
                if (ids.length < 2) return state;

                // rotate by join order
                const list = ids
                    .map(uid => state.players[uid])
                    .sort((a, b) => (a.joinedAt || 0) - (b.joinedAt || 0))
                    .map(p => p.uid);

                const i = list.indexOf(state.turnUid);
                const next = list[(i + 1) % list.length];
                state.turnUid = next;
                return state;
            });

            log(`‚û°Ô∏è Ended turn.`, "warnTxt");
        }

        async function resetGame() {
            if (!room) return;
            await runTransaction(roomRef, (state) => {
                if (!state) return state;
                if (state.ownerUid !== myUid) return state;

                // reset positions + cash to their chosen starting cash (keep avatars)
                for (const uid of Object.keys(state.players || {})) {
                    state.players[uid].pos = 0;
                    // keep cash as-is (or reset if you want):
                    // state.players[uid].cash = state.players[uid].cashStart ?? state.players[uid].cash;
                }
                state.turnUid = state.ownerUid;
                state.lastRoll = null;
                return state;
            });
            log(`‚ôªÔ∏è Game reset by host.`, "warnTxt");
        }

        async function copyCode() {
            const code = ($("roomCode").value || "").trim();
            if (!code) return;
            try {
                await navigator.clipboard.writeText(code);
                log(`üìã Copied room code: ${code}`, "goodTxt");
            } catch {
                log(`Copy failed. Manually share: ${code}`, "warnTxt");
            }
        }

        // ---------- Wire UI ----------
        $("btnCreate").addEventListener("click", createRoom);
        $("btnJoin").addEventListener("click", joinRoom);
        $("btnRoll").addEventListener("click", roll);
        $("btnEnd").addEventListener("click", endTurn);
        $("btnReset").addEventListener("click", resetGame);
        $("btnCopy").addEventListener("click", copyCode);

        renderHotspots();
        log("Ready. Add Firebase config (Step 3), then Create Room.", "warnTxt");
    </script>


    <!-- STEP 3: Firebase config -->
    <script>
        window.__FIREBASE_CONFIG__ = {
            apiKey: "AIzaSyC0vtVUiftBEWSoIzU1Ewfyh0uPUkM",
            authDomain: "apartment-tycoon.firebaseapp.com",
            databaseURL: "https://apartment-tycoon-default-rtdb.firebaseio.com",
            projectId: "apartment-tycoon",
            storageBucket: "apartment-tycoon.appspot.com",
            messagingSenderId: "398055726858",
            appId: "1:398055726858:web:0847944b24edbc03ece4f3"
        };
    </script>
</body>
</html>